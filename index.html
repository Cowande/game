<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Pixel Multiplayer Map - Multiplayer Fix</title>
<style>
html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#111; }
canvas { display:block; background:#228B22; }
#ui {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  color: white;
  font-family: sans-serif;
  padding: 10px;
  background: rgba(0,0,0,0.5);
  box-sizing: border-box;
  z-index: 1000;
  pointer-events: none;
  display: flex;
  gap: 20px;
  font-weight: bold;
}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="ui">
  <span id="playerName">Naam: ?</span>
  <span id="coords">X: 0 Y: 0</span>
  <span id="online">Online: 0</span>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBUgFsK2D_QQtMUQGu-GdMjj8FEeDRE9dA",
  authDomain: "zever-7eca0.firebaseapp.com",
  databaseURL: "https://zever-7eca0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zever-7eca0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Canvas setup
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let tileSize = 32;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Movement
const keys = {};
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

let playerId, playerName, player;

// Setup player
async function setupPlayer() {
  // Uniek ID en naam
  if(localStorage.getItem('playerId')) {
    playerId = localStorage.getItem('playerId');
    playerName = localStorage.getItem('playerName');
  } else {
    playerId = 'u_' + Math.random().toString(36).substr(2,5);
    const t = await db.ref('userCount').transaction(count=>{
      if(count===null) return 1;
      return count+1;
    });
    playerName = t.snapshot.val();
    localStorage.setItem('playerId', playerId);
    localStorage.setItem('playerName', playerName);
  }
  document.getElementById('playerName').innerText = 'Naam: ' + playerName;

  // Player init
  player = { x: 0, y: 0, px:0, py:0, speed: 4 };
  const playerRef = db.ref('players/' + playerId);
  await playerRef.set(player);
  playerRef.onDisconnect().remove();

  // Start listening naar alle spelers
  db.ref('players').on('value', snapshot => {
    allPlayers = snapshot.val() || {};
    document.getElementById('online').innerText = 'Online: ' + Object.keys(allPlayers).length;
  });

  requestAnimationFrame(gameLoop);
}

let allPlayers = {};
setupPlayer();

// Smooth movement helper
function lerp(a,b,t){ return a + (b-a)*t; }
const smoothSpeed = 0.15;

// Game loop
function gameLoop() {
  if(!player) { requestAnimationFrame(gameLoop); return; }

  // Movement
  let targetPx = player.px;
  let targetPy = player.py;
  if(keys['ArrowUp']) targetPy -= player.speed;
  if(keys['ArrowDown']) targetPy += player.speed;
  if(keys['ArrowLeft']) targetPx -= player.speed;
  if(keys['ArrowRight']) targetPx += player.speed;

  player.px = lerp(player.px, targetPx, smoothSpeed);
  player.py = lerp(player.py, targetPy, smoothSpeed);

  player.x = Math.round(player.px / tileSize);
  player.y = Math.round(player.py / tileSize);

  // Update database
  db.ref('players/' + playerId).set({ x: player.x, y: player.y, px: player.px, py: player.py });

  // Camera
  const camX = canvas.width/2 - player.px;
  const camY = canvas.height/2 - player.py;

  // Background
  ctx.fillStyle = '#228B22';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Grid
  const startCol = Math.floor(-camX / tileSize) - 1;
  const endCol = Math.floor((canvas.width - camX) / tileSize) + 1;
  const startRow = Math.floor(-camY / tileSize) - 1;
  const endRow = Math.floor((canvas.height - camY) / tileSize) + 1;

  ctx.strokeStyle = 'rgba(0,100,0,0.5)';
  ctx.lineWidth = 1;
  for(let i=startCol;i<=endCol;i++){
    ctx.beginPath();
    ctx.moveTo(i*tileSize + camX, startRow*tileSize + camY);
    ctx.lineTo(i*tileSize + camX, endRow*tileSize + camY);
    ctx.stroke();
  }
  for(let j=startRow;j<=endRow;j++){
    ctx.beginPath();
    ctx.moveTo(startCol*tileSize + camX, j*tileSize + camY);
    ctx.lineTo(endCol*tileSize + camX, j*tileSize + camY);
    ctx.stroke();
  }

  // Draw players
  for(const id in allPlayers){
    const p = allPlayers[id];
    ctx.fillStyle = id === playerId ? 'red' : 'cyan';
    ctx.fillRect(p.px + camX, p.py + camY, tileSize, tileSize);
  }

  // Update UI
  document.getElementById('coords').innerText = `X: ${player.x} Y: ${player.y}`;

  requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
